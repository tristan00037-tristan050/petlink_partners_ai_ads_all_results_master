<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채널 설정 - 펫링크 파트너스</title>
    
    <!-- 테마 CSS -->
    <link rel="stylesheet" href="/web/shared/theme.css?v=3">
    <!-- 공통 UI -->
    <link rel="stylesheet" href="/web/shared/ui.css?v=3">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-bg, #fff);
            color: var(--color-fg, #333);
            line-height: 1.6;
        }

        header {
            background: var(--color-bg, #fff);
            border-bottom: 2px solid var(--color-border, #e5e7eb);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            padding: 40px 20px;
        }

        .header-content h1 {
            font-size: 36px;
            color: #111;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 20px;
        }

        section {
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 40px 30px;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        section:hover {
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
        }

        section h2 {
            font-size: 28px;
            color: #111;
            margin-bottom: 30px;
            font-weight: 700;
            text-align: center;
        }

        .channel-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .channel-checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            color: #333;
        }

        .channel-checkbox-label:hover {
            border-color: var(--color-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .channel-checkbox-label input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .channel-checkbox-label input[type="checkbox"]:checked + span {
            font-weight: 700;
            color: var(--color-primary);
        }

        .channel-checkbox-label:has(input[type="checkbox"]:checked) {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .animal-override-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
        }

        .animal-override-section h3 {
            font-size: 20px;
            color: #111;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .animal-override-section p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .animal-override-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .animal-override-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--color-primary);
        }

        .btn-primary, .btn-secondary {
            display: inline-block;
            padding: 18px 40px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #fff;
            color: var(--color-primary);
            border: 2px solid var(--color-primary);
        }

        .btn-secondary:hover {
            background: var(--color-primary);
            color: #fff;
            transform: translateY(-3px);
        }

        .button-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 30px;
        }

        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid var(--color-primary);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 4px;
        }

        .result-section {
            margin-top: 30px;
            padding: 24px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .result-section h3 {
            font-size: 18px;
            color: #111;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .hint {
            font-size: 14px;
            color: #666;
            margin-top: 12px;
            line-height: 1.7;
        }

        @media (max-width: 768px) {
            .channel-checkboxes {
                grid-template-columns: 1fr;
            }
            
            section {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>채널 설정</h1>
                <p style="font-size: var(--fs-lg, 18px); color: var(--color-fg, #666); margin-top: var(--space-1, 8px);">광고를 노출할 채널을 선택하세요</p>
        </div>
    </header>

    <div class="container">
        <!-- 매장 기본 채널 설정 -->
        <section class="store-prefs-section">
            <h2>매장 기본 채널 설정</h2>
            <p class="hint" style="text-align: center; margin-bottom: 30px;">
                선택한 채널에 모든 반려동물 광고가 노출됩니다. 동물별로 예외 설정도 가능합니다.
            </p>
            
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="igEnabled" checked>
                    <span>인스타그램/페이스북</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="ttEnabled" checked>
                    <span>틱톡</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="ytEnabled">
                    <span>유튜브</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="kakaoEnabled">
                    <span>카카오</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="naverEnabled">
                    <span>네이버</span>
                </label>
            </div>
            
            <!-- 반경 슬라이더 -->
            <div class="slider-group" style="margin-top: 32px;">
                <label class="form-label">
                    광고 노출 반경
                </label>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <input type="range" class="slider" id="radiusSlider" min="1" max="20" value="6" oninput="updateRadius(this.value)">
                    <span class="badge slider-value" id="radiusValue">6 km</span>
                </div>
                <div class="form-hint">보통 5~7km를 권장합니다.</div>
            </div>
            
            <div class="button-group" style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                <button id="savePrefsBtn" class="btn btn-primary">저장</button>
            </div>
        </section>

        <!-- 동물 등록 및 라우팅 -->
        <section class="animal-register-section">
            <h2>반려동물 등록 & 라우팅</h2>
            <p class="hint" style="text-align: center; margin-bottom: 30px;">
                반려동물을 등록하면 위에서 설정한 채널에 자동으로 광고가 스케줄됩니다.
            </p>
            
            <div class="animal-override-section">
                <h3>이 동물만 예외 설정 (선택사항)</h3>
                <p>매장 기본 설정과 다르게 이 동물만 특정 채널에 노출하거나 제외할 수 있습니다.</p>
                
                <div class="animal-override-checkbox">
                    <input type="checkbox" id="animalOverrideEnabled">
                    <label for="animalOverrideEnabled">동물별 예외 설정 사용</label>
                </div>
                
                <div id="animalOverrideOptions" style="display: none; margin-top: 20px;">
                    <div class="channel-checkboxes">
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalIgEnabled">
                            <span>인스타그램/페이스북</span>
                        </label>
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalTtEnabled">
                            <span>틱톡</span>
                        </label>
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalYtEnabled">
                            <span>유튜브</span>
                        </label>
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalKakaoEnabled">
                            <span>카카오</span>
                        </label>
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalNaverEnabled">
                            <span>네이버</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="registerBtn" class="btn-primary">등록 & 라우팅</button>
            </div>
            
            <div id="resultSection" class="result-section" style="display: none;">
                <h3>스케줄 결과</h3>
                <div id="resultChannels"></div>
            </div>
        </section>
    </div>

    <script>
        const STORE_ID = 1; // 실제로는 로그인한 사용자의 store_id
        const ORCHESTRATOR_URL = window.ORCHESTRATOR_URL || 'http://localhost:8090';
        
        const fetchOptions = {
            headers: {
                'Content-Type': 'application/json'
            }
        };

        // 매장 기본 채널 설정 로드
        async function loadStorePrefs() {
            try {
                const response = await fetch(`${ORCHESTRATOR_URL}/api/stores/${STORE_ID}/channel-prefs`, fetchOptions);
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok && result.data) {
                        document.getElementById('igEnabled').checked = result.data.ig_enabled === 1 || result.data.ig_enabled === true;
                        document.getElementById('ttEnabled').checked = result.data.tt_enabled === 1 || result.data.tt_enabled === true;
                        document.getElementById('ytEnabled').checked = result.data.yt_enabled === 1 || result.data.yt_enabled === true;
                        document.getElementById('kakaoEnabled').checked = result.data.kakao_enabled === 1 || result.data.kakao_enabled === true;
                        document.getElementById('naverEnabled').checked = result.data.naver_enabled === 1 || result.data.naver_enabled === true;
                    }
                }
            } catch (error) {
                console.log('매장 설정 로드 실패 (기본값 사용):', error);
            }
        }

        // 반경 업데이트
        function updateRadius(value) {
            document.getElementById('radiusValue').textContent = value + ' km';
        }

        // 매장 기본 채널 설정 저장
        document.getElementById('savePrefsBtn').addEventListener('click', async () => {
            const prefs = {
                ig_enabled: document.getElementById('igEnabled').checked,
                tt_enabled: document.getElementById('ttEnabled').checked,
                yt_enabled: document.getElementById('ytEnabled').checked,
                kakao_enabled: document.getElementById('kakaoEnabled').checked,
                naver_enabled: document.getElementById('naverEnabled').checked
            };
            
            // 최소 하나는 활성화되어야 함
            const enabledCount = Object.values(prefs).filter(v => v === true).length;
            if (enabledCount === 0) {
                alert('최소 하나의 채널을 활성화해야 합니다.');
                return;
            }
            
            try {
                const response = await fetch(`${ORCHESTRATOR_URL}/api/stores/${STORE_ID}/channel-prefs`, {
                    method: 'PUT',
                    ...fetchOptions,
                    body: JSON.stringify(prefs)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        // 반경도 함께 저장
                        const radius = parseInt(document.getElementById('radiusSlider').value);
                        await fetch(`${ORCHESTRATOR_URL}/api/stores/${STORE_ID}/radius`, {
                            method: 'PUT',
                            ...fetchOptions,
                            body: JSON.stringify({ radius_km: radius })
                        });
                        
                        // 요일별 가중치도 함께 저장 (기본값)
                        await fetch(`${ORCHESTRATOR_URL}/api/stores/${STORE_ID}/weights`, {
                            method: 'PUT',
                            ...fetchOptions,
                            body: JSON.stringify({
                                mon: 1.00, tue: 1.00, wed: 1.00, thu: 1.05,
                                fri: 1.15, sat: 1.30, sun: 1.25, holiday: 1.30
                            })
                        });
                        
                        alert('채널 설정이 저장되었습니다.');
                    } else {
                        alert(result.error || '설정 저장에 실패했습니다.');
                    }
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('설정 저장 실패:', error);
                alert('설정 저장 중 오류가 발생했습니다.');
            }
        });

        // 동물 예외 설정 토글
        document.getElementById('animalOverrideEnabled').addEventListener('change', (e) => {
            document.getElementById('animalOverrideOptions').style.display = e.target.checked ? 'block' : 'none';
        });

        // 동물 등록 & 라우팅
        document.getElementById('registerBtn').addEventListener('click', async () => {
            const useOverride = document.getElementById('animalOverrideEnabled').checked;
            
            // 동물 등록 (예시 데이터)
            const animalData = {
                store_id: STORE_ID,
                name: '테스트 동물',
                type: 'dog',
                breed: '포메라니안',
                age: '1세',
                gender: 'male',
                description: '사랑스러운 강아지입니다.'
            };
            
            try {
                // 1. 동물 등록
                const registerResponse = await fetch(`${BASE_URL}/animals`, {
                    method: 'POST',
                    ...fetchOptions,
                    body: JSON.stringify(animalData)
                });
                
                if (!registerResponse.ok) {
                    throw new Error(`HTTP error! status: ${registerResponse.status}`);
                }
                
                const registerResult = await registerResponse.json();
                
                if (registerResult.ok) {
                    const animalId = registerResult.data.animal_id;
                    const scheduledChannels = registerResult.data.scheduled_channels || [];
                    
                    // 2. 동물 예외 설정이 있으면 저장
                    if (useOverride) {
                        const overridePrefs = {
                            ig_enabled: document.getElementById('animalIgEnabled').checked ? true : null,
                            tt_enabled: document.getElementById('animalTtEnabled').checked ? true : null,
                            yt_enabled: document.getElementById('animalYtEnabled').checked ? true : null,
                            kakao_enabled: document.getElementById('animalKakaoEnabled').checked ? true : null,
                            naver_enabled: document.getElementById('animalNaverEnabled').checked ? true : null
                        };
                        
                        await fetch(`${BASE_URL}/animals/${animalId}/channel-overrides`, {
                            method: 'PUT',
                            ...fetchOptions,
                            body: JSON.stringify(overridePrefs)
                        });
                    }
                    
                    // 3. 결과 표시
                    const resultSection = document.getElementById('resultSection');
                    const resultChannels = document.getElementById('resultChannels');
                    
                    if (scheduledChannels.length === 0) {
                        resultChannels.innerHTML = '<p style="color: #666;">활성화된 채널이 없어 전송되지 않습니다.</p>';
                    } else {
                        resultChannels.innerHTML = scheduledChannels.map(ch => 
                            `<span class="result-badge">${ch}</span>`
                        ).join('');
                    }
                    
                    resultSection.style.display = 'block';
                    alert('동물이 등록되었고 광고가 스케줄되었습니다.');
                } else {
                    alert(registerResult.error || '동물 등록에 실패했습니다.');
                }
            } catch (error) {
                console.error('동물 등록 실패:', error);
                alert('동물 등록 중 오류가 발생했습니다.');
            }
        });

        // CPM 로드 (v2.6 r3)
        async function loadCPM() {
            try {
                const response = await fetch(`${ORCHESTRATOR_URL}/api/stores/${STORE_ID}/cpm`, fetchOptions);
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok && result.data) {
                        console.log('CPM 정보:', result.data.cpm);
                        // CPM 정보를 UI에 표시할 수 있음
                    }
                }
            } catch (error) {
                console.log('CPM 로드 실패:', error);
            }
        }
        
        // 공휴일 로드 (v2.6 r3)
        async function loadHolidays() {
            try {
                const response = await fetch(`${ORCHESTRATOR_URL}/api/settings/holidays`, fetchOptions);
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok && result.data) {
                        console.log('공휴일 정보:', result.data.holidays);
                        // 공휴일 정보를 UI에 표시할 수 있음
                    }
                }
            } catch (error) {
                console.log('공휴일 로드 실패:', error);
            }
        }
        
        // 초기 로드
        loadStorePrefs();
        loadCPM();
        loadHolidays();
    </script>
</body>
</html>

