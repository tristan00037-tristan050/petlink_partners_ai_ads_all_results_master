다음 단계 r9.4 — 주·월 리포트 템플릿(스파크라인) + 상태 캐시(60s) + Pilot Home 빠른 로딩을 즉시 집행합니다.
유지할 것(필수 4), **분리 경계(App↔Admin CORS/스코프/RBAC/감사)**는 그대로 보존합니다.

프리플라이트(필수)

server/app.js, scripts/run_sql.js 존재

환경값: ADMIN_KEY, APP_ORIGIN, ADMIN_ORIGIN 유효

r7.9/r8.3 기준의 mw/cors_split.js, mw/admin_gate.js 존재

성공 문자열(모두 출력되면 PASS)
TRENDS JSON OK
TRENDS HTML OK
STATUS CACHE OK
HOME FAST OK
SPLIT ORIGINS STILL OK (ADMIN)
SPLIT ORIGINS STILL OK (APP)

원클릭 — r9.4 트렌드(주·월) + 캐시(60s) + 홈 빠른 로딩 (무중단, 분리 경계 유지)

아래 블록을 저장소 루트 터미널에 그대로 붙여 실행하세요.

#!/usr/bin/env bash
set -euo pipefail
mkdir -p server/lib server/routes server/openapi

export PORT="${PORT:-5902}"
export ADMIN_KEY="${ADMIN_KEY:-admin-dev-key-123}"
export APP_ORIGIN="${APP_ORIGIN:-http://localhost:3000}"
export ADMIN_ORIGIN="${ADMIN_ORIGIN:-http://localhost:8000}"

need(){ command -v "$1" >/dev/null 2>&1 || { echo "[need] $1 미설치"; exit 1; }; }
need node; need curl
test -f server/app.js || { echo "[ERR] server/app.js 없음"; exit 1; }
test -f scripts/run_sql.js || { echo "[ERR] scripts/run_sql.js 없음"; exit 1; }

# ===== 1) 60초 메모리 캐시 유틸 =====
cat > server/lib/cache60.js <<'JS'
const store = new Map(); // key -> { exp:number, val:any }
function key(req){ return (req.method||'GET') + ' ' + (req.originalUrl||req.url); }
function get(k){ const v=store.get(k); if(!v) return null; if(Date.now()>v.exp){ store.delete(k); return null; } return v.val; }
function set(k,val,ttlSec=60){ store.set(k,{ exp: Date.now()+ttlSec*1000, val }); }
function withCache(ttlSec, loader){
  return async (req,res)=>{
    const k=key(req); const hit=get(k); 
    if(hit){ res.set('Cache-Control', `public, max-age=${ttlSec}`); return res.json(hit); }
    const data = await loader(req,res);
    set(k,data,ttlSec); res.set('Cache-Control', `public, max-age=${ttlSec}`); return res.json(data);
  };
}
module.exports = { withCache, get, set };
JS

# ===== 2) App 상태 캐시 라우트(/app/pilot/status.cached.json) =====
cat > server/routes/app_pilot_status_cache.js <<'JS'
const express=require('express');
const fetchFn=(global.fetch||require('node-fetch'));
const { withCache } = require('../lib/cache60');
const { appCORS } = (function(){ try { return require('../mw/cors_split'); } catch(e){ return {}; } })();
const r=express.Router();

async function fetchStatus(){
  try{
    const res = await fetchFn('http://localhost:'+(process.env.PORT||'5902')+'/app/pilot/status.json', { headers:{}, redirect:'follow' });
    if(!res.ok) return { ok:false, go:false, cached:false };
    const j = await res.json(); 
    return Object.assign({ cached:true }, j);
  }catch(_){ return { ok:false, go:false, cached:false, error:'upstream-failed' }; }
}
r.get('/app/pilot/status.cached.json', appCORS||((req,res,next)=>next()), withCache(60, async()=> await fetchStatus()));
module.exports = r;
JS

# ===== 3) Admin 트렌드(주·월) + HTML 스파크라인 =====
cat > server/routes/admin_pilot_trends.js <<'JS'
const express=require('express');
const db=require('../lib/db');
const fetchFn=(global.fetch||require('node-fetch'));
const { withCache } = require('../lib/cache60');
let requireAdminAny; try{ requireAdminAny = require('../mw/admin_gate').requireAdminAny; }catch(e){ requireAdminAny=null; }
const { adminCORS } = (function(){ try { return require('../mw/cors_split'); } catch(e){ return {}; } })();
const r=express.Router();
const guard=(req,res,next)=> (requireAdminAny ? requireAdminAny(req,res,next) :
  (req.get('X-Admin-Key')===(process.env.ADMIN_KEY||'') ? next() : res.status(401).json({ok:false,code:'ADMIN_AUTH_REQUIRED'})));

async function weeklyPayments(days=56){
  const q = await db.q(`
    WITH b AS (
      SELECT date_trunc('week', created_at) AS wk, status
      FROM ad_payments
      WHERE created_at >= now() - ($1||' days')::interval
    )
    SELECT wk::date AS bucket,
           SUM((status='CAPTURED')::int)::int AS ok,
           SUM((status='FAILED')::int)::int AS fail,
           COUNT(*)::int AS total
    FROM b GROUP BY 1 ORDER BY 1
  `,[days]);
  return q.rows.map(x=>({ bucket:String(x.bucket), ok:+x.ok||0, fail:+x.fail||0, total:+x.total||0,
    success_rate: (+x.total? (+x.ok/+x.total):1) }));
}
async function weeklyAutoApprove(days=56){
  const q = await db.q(`
    WITH b AS (
      SELECT date_trunc('week', created_at) AS wk,
             COALESCE((flags->>'final')::text,'') AS final,
             EXTRACT(EPOCH FROM (approved_at - created_at)) AS lead
      FROM ad_creatives
      WHERE created_at >= now() - ($1||' days')::interval
    )
    SELECT wk::date AS bucket,
           SUM((final='approved')::int)::int AS approved,
           COUNT(*)::int AS total,
           SUM(CASE WHEN final='approved' AND lead IS NOT NULL AND lead<=300 THEN 1 ELSE 0 END)::int AS under5m
    FROM b GROUP BY 1 ORDER BY 1
  `,[days]);
  return q.rows.map(x=>({ bucket:String(x.bucket),
    auto_rate: (+x.total? (+x.approved/+x.total):1),
    under5m_rate: (+x.total? (+x.under5m/+x.total):1),
    total:+x.total||0
  }));
}
async function weeklySessionP95(days=56){
  try{
    const q = await db.q(`
      WITH raw AS (
        SELECT date_trunc('week', created_at) AS wk,
               NULLIF((meta->>'ms'),'')::numeric AS lat
        FROM session_events
        WHERE created_at >= now() - ($1||' days')::interval
          AND kind IN ('refresh_ok','refresh_fail')
      )
      SELECT wk::date AS bucket,
             percentile_disc(0.95) WITHIN GROUP (ORDER BY lat) AS p95_ms
      FROM raw WHERE lat IS NOT NULL GROUP BY 1 ORDER BY 1
    `,[days]);
    return q.rows.map(x=>({ bucket:String(x.bucket), p95_ms: Number(x.p95_ms||0) }));
  }catch(_){ return []; }
}
async function monthlyPayments(months=6){
  const q=await db.q(`
    WITH b AS(
      SELECT date_trunc('month', created_at) AS mk, status
      FROM ad_payments WHERE created_at >= now() - ($1||' months')::interval
    )
    SELECT mk::date AS bucket, SUM((status='CAPTURED')::int)::int ok,
           SUM((status='FAILED')::int)::int fail, COUNT(*)::int total
    FROM b GROUP BY 1 ORDER BY 1
  `,[months]);
  return q.rows.map(x=>({ bucket:String(x.bucket), ok:+x.ok||0, fail:+x.fail||0, total:+x.total||0,
    success_rate:(+x.total? (+x.ok/+x.total):1) }));
}

r.get('/pilot/trends.json', adminCORS||((req,res,next)=>next()), guard,
  withCache(60, async ()=>{
    const weekly = await weeklyPayments(56);
    const auto = await weeklyAutoApprove(56);
    const sess = await weeklySessionP95(56);
    const monthly = await monthlyPayments(6);
    return { ok:true, weekly, auto, sess, monthly };
}));

r.get('/pilot/trends', adminCORS||((req,res,next)=>next()), guard, async (req,res)=>{
  const j = await (await fetchFn('http://localhost:'+(process.env.PORT||'5902')+'/admin/reports/pilot/trends.json',
                                { headers:{'X-Admin-Key':process.env.ADMIN_KEY||''}})).json();
  const spark = (arr, key, w=220, h=40)=>{
    const nums = (arr||[]).map(x=> Number(x[key]||0));
    if(!nums.length) return `<svg width="${w}" height="${h}"></svg>`;
    const min = Math.min(...nums), max = Math.max(...nums);
    const nx = i => (i/(nums.length-1))*(w-6)+3;
    const ny = v => h-3 - (max-min ? ((v-min)/(max-min))*(h-10) : 0);
    const pts = nums.map((v,i)=> `${nx(i)},${ny(v)}`).join(' ');
    return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <polyline fill="none" stroke="#666" stroke-width="1" points="${pts}"/>
    </svg>`;
  };
  res.setHeader('Content-Type','text/html; charset=utf-8');
  res.end(`<!doctype html><meta charset="utf-8"><title>Pilot Trends</title>
  <div style="font:14px system-ui,Arial;padding:16px;display:flex;gap:12px;flex-wrap:wrap">
    <div style="border:1px solid #ddd;border-radius:8px;padding:12px;min-width:260px">
      <h3 style="margin:0 0 6px">Weekly Success Rate</h3>
      ${spark(j.weekly,'success_rate')}
    </div>
    <div style="border:1px solid #ddd;border-radius:8px;padding:12px;min-width:260px">
      <h3 style="margin:0 0 6px">Weekly Auto-Approve</h3>
      ${spark(j.auto,'auto_rate')}
    </div>
    <div style="border:1px solid #ddd;border-radius:8px;padding:12px;min-width:260px">
      <h3 style="margin:0 0 6px">Weekly Session p95(ms)</h3>
      ${spark(j.sess,'p95_ms')}
    </div>
    <div style="border:1px solid #ddd;border-radius:8px;padding:12px;min-width:260px">
      <h3 style="margin:0 0 6px">Monthly Success Rate</h3>
      ${spark(j.monthly,'success_rate')}
    </div>
  </div>`);
});
module.exports = r;
JS

# ===== 4) Pilot Home 빠른 로딩(프리렌더) =====
cat > server/routes/admin_home_fast.js <<'JS'
const express=require('express');
const fetchFn=(global.fetch||require('node-fetch'));
let requireAdminAny; try{ requireAdminAny = require('../mw/admin_gate').requireAdminAny; }catch(e){ requireAdminAny=null; }
const { adminCORS } = (function(){ try { return require('../mw/cors_split'); } catch(e){ return {}; } })();
const r=express.Router();
const guard=(req,res,next)=> (requireAdminAny ? requireAdminAny(req,res,next) :
  (req.get('X-Admin-Key')===(process.env.ADMIN_KEY||'') ? next() : res.status(401).json({ok:false,code:'ADMIN_AUTH_REQUIRED'})));
r.get('/home-fast', adminCORS||((req,res,next)=>next()), guard, async (req,res)=>{
  let j={ ok:false }; 
  try{
    const resp = await fetchFn('http://localhost:'+(process.env.PORT||'5902')+'/admin/reports/home.json',{ headers:{'X-Admin-Key':process.env.ADMIN_KEY||''}});
    j = await resp.json();
  }catch(_){}
  res.setHeader('Content-Type','text/html; charset=utf-8');
  const jsonStr = JSON.stringify(j);
  res.end(`<!doctype html><meta charset="utf-8"><title>Pilot Home (Fast)</title>
  <script>window.__PILOT_HOME__=` + jsonStr + `;</script>
  <div style="font:14px system-ui,Arial;padding:16px">
    <h2 style="margin-top:0">Pilot Home (Fast)</h2>
    <pre id="out" style="white-space:pre-wrap;background:#f8f8f8;padding:12px;border-radius:6px"></pre>
  </div>
  <script>
    (function(){ document.getElementById('out').textContent = JSON.stringify(window.__PILOT_HOME__, null, 2); })();
  </script>`);
});
module.exports = r;
JS

# ===== 5) OpenAPI 문서 =====
cat > server/openapi/pilot_trends.yaml <<'YAML'
openapi: 3.0.3
info: { title: Pilot Trends & Cache, version: "r9.4" }
paths:
  /admin/reports/pilot/trends.json: { get: { summary: Weekly/Monthly trends JSON, responses: { '200': { description: OK } } } }
  /admin/reports/pilot/trends:      { get: { summary: Trends HTML with sparklines, responses: { '200': { description: OK } } } }
  /admin/reports/home-fast:         { get: { summary: Pilot Home preloaded HTML, responses: { '200': { description: OK } } } }
  /app/pilot/status.cached.json:    { get: { summary: App Pilot status (60s cache), responses: { '200': { description: OK } } } }
YAML

# ===== 6) app.js 마운트(경계 준수) =====
# Admin(트렌드/홈패스트): adminCORS + Admin Gate 내부
grep -q "routes/admin_pilot_trends" server/app.js || \
  sed -i.bak "1,200{/app\.use('\/admin',/ a\
app.use('/admin/reports', (require('./mw/cors_split')?.adminCORS)||((req,res,next)=>next()), require('./routes/admin_pilot_trends'));\
app.use('/admin/reports', (require('./mw/cors_split')?.adminCORS)||((req,res,next)=>next()), require('./routes/admin_home_fast'));\
}" server/app.js && rm -f server/app.js.bak

# App(상태 캐시): appCORS 내부
grep -q "routes/app_pilot_status_cache" server/app.js || \
  sed -i.bak "1,200{/app\.use('\/auth',.*appCORS,/ a\
app.use('/', (require('./mw/cors_split')?.appCORS)||((req,res,next)=>next()), require('./routes/app_pilot_status_cache'));\
}" server/app.js && rm -f server/app.js.bak

# OpenAPI 노출
grep -q "openapi/pilot_trends.yaml" server/app.js || \
  sed -i.bak "1,200{/express\.json/ a\
app.get('/openapi_pilot_trends.yaml',(req,res)=>res.sendFile(require('path').join(__dirname,'openapi','pilot_trends.yaml')));\
}" server/app.js && rm -f server/app.js.bak

# ===== 7) 무중단 재기동 & 헬스 =====
if [ -f .petlink.pid ]; then PID="$(cat .petlink.pid||true)"; [ -n "${PID:-}" ] && kill "$PID" 2>/dev/null || true; fi
node server/app.js > .petlink.out 2>&1 & echo $! > .petlink.pid
sleep 1
curl -sf "http://localhost:${PORT}/health" >/dev/null

# ===== 8) 스모크 =====
# Trends JSON/HTML
curl -sf "http://localhost:${PORT}/admin/reports/pilot/trends.json" -H "X-Admin-Key: ${ADMIN_KEY}" | grep -q '"ok":true' && echo "TRENDS JSON OK"
curl -sf "http://localhost:${PORT}/admin/reports/pilot/trends"      -H "X-Admin-Key: ${ADMIN_KEY}" >/dev/null && echo "TRENDS HTML OK"

# App 상태 캐시
curl -sf "http://localhost:${PORT}/app/pilot/status.cached.json" -H "Origin: ${APP_ORIGIN}" | grep -Eq '"ok":(true|false)' && echo "STATUS CACHE OK"

# Home Fast(프리렌더)
curl -sf "http://localhost:${PORT}/admin/reports/home-fast" -H "X-Admin-Key: ${ADMIN_KEY}" | grep -q "__PILOT_HOME__" && echo "HOME FAST OK"

# CORS 경계 재검증
curl -sfI "http://localhost:${PORT}/admin/reports/pilot/trends" -H "Origin: ${ADMIN_ORIGIN}" | grep -qi "access-control-allow-origin: ${ADMIN_ORIGIN}" && echo "SPLIT ORIGINS STILL OK (ADMIN)"
curl -sfI "http://localhost:${PORT}/app/ui/banner.v2.js"        -H "Origin: ${APP_ORIGIN}"   | grep -qi "access-control-allow-origin: ${APP_ORIGIN}"   && echo "SPLIT ORIGINS STILL OK (APP)"

사용 경로

Admin 트렌드(주·월):

JSON: GET /admin/reports/pilot/trends.json

HTML: GET /admin/reports/pilot/trends

Pilot Home 빠른 로딩: GET /admin/reports/home-fast

App 상태(60s 캐시): GET /app/pilot/status.cached.json

문서: GET /openapi_pilot_trends.yaml

범위·게이트 준수

웹앱 자동 승인 루프 / 프로필 / 월 결제(SBX) / 어드민 최소 3지표: 변경 없음

App↔Admin 분리·CORS·스코프·RBAC·감사: 그대로 유지

중단 항목(킬스위치·서킷·SSO 고급·증빙 번들 확장·대량 Import 등): 비활성 유지

완료 보고 형식

위 블록 실행 후, 아래 성공 문자열 6개를 그대로 전달해 주십시오.

TRENDS JSON OK
TRENDS HTML OK
STATUS CACHE OK
HOME FAST OK
SPLIT ORIGINS STILL OK (ADMIN)
SPLIT ORIGINS STILL OK (APP)


보고 접수 즉시, r9.5 “배지/배너 상태 60s 캐시를 홈 대시보드에도 공유(서버내 공용 캐시) + 홈/트렌드 프리로드 링크 삽입 + 일 단위 SLO 위반 플래그 표시” 오버레이로 이어가겠습니다.<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채널 설정 - 펫링크 파트너스</title>
    
    <!-- Landing CSS 먼저 포함 -->
    <link rel="stylesheet" href="/frontend/landing.css">
    <!-- UI 테마 및 컴포넌트 -->
    <link rel="stylesheet" href="/web/ui/theme.css">
    <link rel="stylesheet" href="/web/ui/components.css">
    
    <script src="/web/js/theme_sync.js"></script>
    <script src="/web/js/ui.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fff;
            color: #333;
            line-height: 1.6;
        }

        header {
            background: #fff;
            border-bottom: 2px solid #e5e7eb;
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            padding: 40px 20px;
        }

        .header-content h1 {
            font-size: 36px;
            color: #111;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 20px;
        }

        section {
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 40px 30px;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        section:hover {
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
        }

        section h2 {
            font-size: 28px;
            color: #111;
            margin-bottom: 30px;
            font-weight: 700;
            text-align: center;
        }

        .channel-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .channel-checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            color: #333;
        }

        .channel-checkbox-label:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .channel-checkbox-label input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .channel-checkbox-label input[type="checkbox"]:checked + span {
            font-weight: 700;
            color: #667eea;
        }

        .channel-checkbox-label:has(input[type="checkbox"]:checked) {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .animal-override-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
        }

        .animal-override-section h3 {
            font-size: 20px;
            color: #111;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .animal-override-section p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .animal-override-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .animal-override-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .btn-primary, .btn-secondary {
            display: inline-block;
            padding: 18px 40px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #fff;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: #fff;
            transform: translateY(-3px);
        }

        .button-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 30px;
        }

        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin: 4px;
        }

        .result-section {
            margin-top: 30px;
            padding: 24px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .result-section h3 {
            font-size: 18px;
            color: #111;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .hint {
            font-size: 14px;
            color: #666;
            margin-top: 12px;
            line-height: 1.7;
        }

        @media (max-width: 768px) {
            .channel-checkboxes {
                grid-template-columns: 1fr;
            }
            
            section {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>채널 설정</h1>
            <p style="font-size: 18px; color: #666; margin-top: 8px;">광고를 노출할 채널을 선택하세요</p>
        </div>
    </header>

    <div class="container">
        <!-- 매장 기본 채널 설정 -->
        <section class="store-prefs-section">
            <h2>매장 기본 채널 설정</h2>
            <p class="hint" style="text-align: center; margin-bottom: 30px;">
                선택한 채널에 모든 반려동물 광고가 노출됩니다. 동물별로 예외 설정도 가능합니다.
            </p>
            
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="igEnabled" checked>
                    <span>인스타그램/페이스북</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="ttEnabled" checked>
                    <span>틱톡</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="ytEnabled">
                    <span>유튜브</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="kakaoEnabled">
                    <span>카카오</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="naverEnabled">
                    <span>네이버</span>
                </label>
            </div>
            
            <!-- 반경 슬라이더 -->
            <div class="slider-group" style="margin-top: 32px;">
                <label class="form-label">
                    광고 노출 반경
                </label>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <input type="range" class="slider" id="radiusSlider" min="1" max="20" value="6" oninput="updateRadius(this.value)">
                    <span class="badge slider-value" id="radiusValue">6 km</span>
                </div>
                <div class="form-hint">보통 5~7km를 권장합니다.</div>
            </div>
            
            <div class="button-group" style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                <button id="savePrefsBtn" class="btn btn-primary">저장</button>
            </div>
        </section>

        <!-- 동물 등록 및 라우팅 -->
        <section class="animal-register-section">
            <h2>반려동물 등록 & 라우팅</h2>
            <p class="hint" style="text-align: center; margin-bottom: 30px;">
                반려동물을 등록하면 위에서 설정한 채널에 자동으로 광고가 스케줄됩니다.
            </p>
            
            <div class="animal-override-section">
                <h3>이 동물만 예외 설정 (선택사항)</h3>
                <p>매장 기본 설정과 다르게 이 동물만 특정 채널에 노출하거나 제외할 수 있습니다.</p>
                
                <div class="animal-override-checkbox">
                    <input type="checkbox" id="animalOverrideEnabled">
                    <label for="animalOverrideEnabled">동물별 예외 설정 사용</label>
                </div>
                
                <div id="animalOverrideOptions" style="display: none; margin-top: 20px;">
                    <div class="channel-checkboxes">
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalIgEnabled">
                            <span>인스타그램/페이스북</span>
                        </label>
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalTtEnabled">
                            <span>틱톡</span>
                        </label>
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalYtEnabled">
                            <span>유튜브</span>
                        </label>
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalKakaoEnabled">
                            <span>카카오</span>
                        </label>
                        <label class="channel-checkbox-label">
                            <input type="checkbox" id="animalNaverEnabled">
                            <span>네이버</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="registerBtn" class="btn-primary">등록 & 라우팅</button>
            </div>
            
            <div id="resultSection" class="result-section" style="display: none;">
                <h3>스케줄 결과</h3>
                <div id="resultChannels"></div>
            </div>
        </section>
    </div>

    <script>
        const STORE_ID = 1; // 실제로는 로그인한 사용자의 store_id
        const BASE_URL = window.API_BASE_URL || 'http://localhost:3002'; // pet_management_ms
        
        const fetchOptions = {
            headers: {
                'Content-Type': 'application/json'
            }
        };

        // 매장 기본 채널 설정 로드
        async function loadStorePrefs() {
            try {
                const response = await fetch(`${BASE_URL}/stores/${STORE_ID}/channel-prefs`, fetchOptions);
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok && result.data) {
                        document.getElementById('igEnabled').checked = result.data.ig_enabled === 1 || result.data.ig_enabled === true;
                        document.getElementById('ttEnabled').checked = result.data.tt_enabled === 1 || result.data.tt_enabled === true;
                        document.getElementById('ytEnabled').checked = result.data.yt_enabled === 1 || result.data.yt_enabled === true;
                        document.getElementById('kakaoEnabled').checked = result.data.kakao_enabled === 1 || result.data.kakao_enabled === true;
                        document.getElementById('naverEnabled').checked = result.data.naver_enabled === 1 || result.data.naver_enabled === true;
                    }
                }
            } catch (error) {
                console.log('매장 설정 로드 실패 (기본값 사용):', error);
            }
        }

        // 반경 업데이트
        function updateRadius(value) {
            document.getElementById('radiusValue').textContent = value + ' km';
        }

        // 매장 기본 채널 설정 저장
        document.getElementById('savePrefsBtn').addEventListener('click', async () => {
            const prefs = {
                ig_enabled: document.getElementById('igEnabled').checked,
                tt_enabled: document.getElementById('ttEnabled').checked,
                yt_enabled: document.getElementById('ytEnabled').checked,
                kakao_enabled: document.getElementById('kakaoEnabled').checked,
                naver_enabled: document.getElementById('naverEnabled').checked
            };
            
            // 최소 하나는 활성화되어야 함
            const enabledCount = Object.values(prefs).filter(v => v === true).length;
            if (enabledCount === 0) {
                alert('최소 하나의 채널을 활성화해야 합니다.');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/stores/${STORE_ID}/channel-prefs`, {
                    method: 'PUT',
                    ...fetchOptions,
                    body: JSON.stringify(prefs)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        // 반경도 함께 저장
                        const radius = parseInt(document.getElementById('radiusSlider').value);
                        await fetch(`${BASE_URL}/stores/${STORE_ID}/radius`, {
                            method: 'PUT',
                            ...fetchOptions,
                            body: JSON.stringify({ radius_km: radius })
                        });
                        
                        UI.showToast('채널 설정이 저장되었습니다.', 'success');
                    } else {
                        UI.showToast(result.error || '설정 저장에 실패했습니다.', 'error');
                    }
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('설정 저장 실패:', error);
                UI.showToast('설정 저장 중 오류가 발생했습니다.', 'error');
            }
        });

        // 동물 예외 설정 토글
        document.getElementById('animalOverrideEnabled').addEventListener('change', (e) => {
            document.getElementById('animalOverrideOptions').style.display = e.target.checked ? 'block' : 'none';
        });

        // 동물 등록 & 라우팅
        document.getElementById('registerBtn').addEventListener('click', async () => {
            const useOverride = document.getElementById('animalOverrideEnabled').checked;
            
            // 동물 등록 (예시 데이터)
            const animalData = {
                store_id: STORE_ID,
                name: '테스트 동물',
                type: 'dog',
                breed: '포메라니안',
                age: '1세',
                gender: 'male',
                description: '사랑스러운 강아지입니다.'
            };
            
            try {
                // 1. 동물 등록
                const registerResponse = await fetch(`${BASE_URL}/animals`, {
                    method: 'POST',
                    ...fetchOptions,
                    body: JSON.stringify(animalData)
                });
                
                if (!registerResponse.ok) {
                    throw new Error(`HTTP error! status: ${registerResponse.status}`);
                }
                
                const registerResult = await registerResponse.json();
                
                if (registerResult.ok) {
                    const animalId = registerResult.data.animal_id;
                    const scheduledChannels = registerResult.data.scheduled_channels || [];
                    
                    // 2. 동물 예외 설정이 있으면 저장
                    if (useOverride) {
                        const overridePrefs = {
                            ig_enabled: document.getElementById('animalIgEnabled').checked ? true : null,
                            tt_enabled: document.getElementById('animalTtEnabled').checked ? true : null,
                            yt_enabled: document.getElementById('animalYtEnabled').checked ? true : null,
                            kakao_enabled: document.getElementById('animalKakaoEnabled').checked ? true : null,
                            naver_enabled: document.getElementById('animalNaverEnabled').checked ? true : null
                        };
                        
                        await fetch(`${BASE_URL}/animals/${animalId}/channel-overrides`, {
                            method: 'PUT',
                            ...fetchOptions,
                            body: JSON.stringify(overridePrefs)
                        });
                    }
                    
                    // 3. 결과 표시
                    const resultSection = document.getElementById('resultSection');
                    const resultChannels = document.getElementById('resultChannels');
                    
                    if (scheduledChannels.length === 0) {
                        resultChannels.innerHTML = '<p style="color: #666;">활성화된 채널이 없어 전송되지 않습니다.</p>';
                    } else {
                        resultChannels.innerHTML = scheduledChannels.map(ch => 
                            `<span class="result-badge">${ch}</span>`
                        ).join('');
                    }
                    
                    resultSection.style.display = 'block';
                    alert('동물이 등록되었고 광고가 스케줄되었습니다.');
                } else {
                    alert(registerResult.error || '동물 등록에 실패했습니다.');
                }
            } catch (error) {
                console.error('동물 등록 실패:', error);
                alert('동물 등록 중 오류가 발생했습니다.');
            }
        });

        // 초기 로드
        loadStorePrefs();
    </script>
</body>
</html>

